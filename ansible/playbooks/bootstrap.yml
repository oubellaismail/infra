- name: Bootstrap Infrastructure - Initial Server Setup
  hosts: all,!ungrouped
  gather_facts: true
  serial: "{{ ansible_serial | default(1) }}"
  vars:
    ansible_ssh_retries: 3

  pre_tasks:
    - name: Wait for system to be ready
      wait_for_connection:
        connect_timeout: 20
        sleep: 5
        delay: 5
        timeout: 300

    - name: Detect if we're running as root (first-time setup)
      set_fact:
        is_initial_setup: "{{ ansible_user == 'root' }}"
      tags: ['always']

  roles:
    # Create Ansible user FIRST (only during initial setup)
    - role: ansible_user
      tags: ['ansible_user', 'bootstrap']
      when: is_initial_setup | default(false)

    - role: common
      tags: ['common', 'bootstrap']
    
    - role: ssh_hardening
      tags: ['ssh', 'security', 'bootstrap']
      # Apply SSH hardening to all hosts, but with different configs
    
    - role: firewall
      tags: ['firewall', 'security', 'bootstrap']
    
    - role: fail2ban
      tags: ['fail2ban', 'security', 'bootstrap']
      when: inventory_hostname in groups['bastion']

- name: Bootstrap Application Servers
  hosts: app_servers
  gather_facts: false
  serial: "{{ ansible_serial | default(1) }}"

  roles:
    - role: docker_runtime
      tags: ['docker', 'bootstrap']
    - role: registry_login
      tags: ['registry', 'bootstrap']

- name: Bootstrap Frontend Servers
  hosts: frontend
  gather_facts: false
  serial: "{{ ansible_serial | default(1) }}"

  roles:
    - role: nginx_tls
      tags: ['nginx', 'tls', 'bootstrap']

- name: Setup Monitoring and Observability
  hosts: all
  gather_facts: false
  serial: "{{ ansible_serial | default(1) }}"

  roles:
    - role: observability
      tags: ['monitoring', 'observability', 'bootstrap']

- name: Verify Bootstrap
  hosts: all
  gather_facts: false
  serial: "{{ ansible_serial | default(1) }}"

  roles:
    - role: verify
      tags: ['verify', 'bootstrap']